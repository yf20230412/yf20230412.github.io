<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级网盘与工具配置生成器 v3.2 (导入再优化)</title>
    <!-- SortableJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* CSS remains the same as previous version */
        :root{--primary-color:#007bff;--secondary-color:#6c757d;--light-gray:#f8f9fa;--medium-gray:#e9ecef;--dark-gray:#343a40;--success-color:#28a745;--danger-color:#dc3545;--border-radius:8px;--box-shadow:0 4px 12px rgba(0,0,0,.1);--transition-speed:.3s}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;padding:20px;max-width:900px;margin:20px auto;background-color:var(--light-gray);color:var(--dark-gray)}.container{background-color:#fff;padding:30px 40px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);transition:all var(--transition-speed) ease}h1,h2,h3{color:var(--dark-gray);border-bottom:1px solid var(--medium-gray);padding-bottom:10px;margin-bottom:25px}h1{text-align:center;color:var(--primary-color);border-bottom:2px solid var(--primary-color)}label{display:block;margin-bottom:8px;font-weight:600;color:#555}input[type=text],input[type=password],textarea,select{width:100%;padding:12px 15px;margin-bottom:18px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;transition:border-color var(--transition-speed) ease,box-shadow var(--transition-speed) ease;font-size:1rem}input:focus,textarea:focus,select:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}textarea{min-height:80px;resize:vertical}button,.button-like{background-color:var(--primary-color);color:#fff;padding:12px 25px;border:none;border-radius:4px;cursor:pointer;font-size:1rem;font-weight:500;transition:background-color var(--transition-speed) ease,transform var(--transition-speed) ease;margin-right:10px;margin-bottom:10px;display:inline-block;text-align:center}button:hover,.button-like:hover{background-color:#0056b3;transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.2)}button.secondary,.button-like.secondary{background-color:var(--secondary-color)}button.secondary:hover,.button-like.secondary:hover{background-color:#5a6268}button.danger,.button-like.danger{background-color:var(--danger-color)}button.danger:hover,.button-like.danger:hover{background-color:#c82333}#outputJson{background-color:var(--medium-gray);font-family:'Courier New',Courier,monospace;white-space:pre;overflow-x:auto;border:1px solid #ccc;border-radius:4px;padding:15px;margin-top:20px;min-height:150px}.field-group{margin-bottom:30px;padding:20px;border:1px solid var(--medium-gray);border-radius:var(--border-radius);background-color:#fdfdfd;transition:box-shadow var(--transition-speed) ease}.field-group:hover{box-shadow:0 2px 8px rgba(0,0,0,.08)}.field-group h3{margin-top:0;margin-bottom:20px;font-size:1.2em;color:var(--primary-color);border-bottom:none}.description{font-size:.95em;color:#666;margin-bottom:15px;background-color:#eef;padding:10px;border-radius:4px;border-left:4px solid var(--primary-color)}.sortable-list{list-style:none;padding:10px;margin-bottom:20px;border:1px dashed #ccc;border-radius:4px;min-height:50px;background-color:var(--light-gray)}.draggable-item{background-color:#fff;padding:10px 15px;margin-bottom:8px;border:1px solid #ddd;border-radius:4px;cursor:grab;display:flex;justify-content:space-between;align-items:center;transition:background-color var(--transition-speed) ease,box-shadow var(--transition-speed) ease}.draggable-item:hover{background-color:#f0f0f0;box-shadow:0 1px 4px rgba(0,0,0,.1)}.draggable-item .handle{font-weight:700;margin-right:10px;color:#aaa;cursor:inherit}.draggable-item .item-name{flex-grow:1}.sortable-ghost{opacity:.4;background:#c8ebfb;border:1px dashed var(--primary-color)}.sortable-chosen{background-color:#e6f7ff;box-shadow:0 3px 8px rgba(0,0,0,.15)}.sortable-drag{cursor:grabbing!important}.checkbox-label,.checkbox-label-inline{display:inline-flex;align-items:center;cursor:pointer;margin-right:15px;margin-bottom:5px}.draggable-item .checkbox-label{display:flex;margin-right:0;margin-left:15px}.checkbox-label input[type=checkbox],.checkbox-label-inline input[type=checkbox]{width:auto;margin:0 5px 0 0;cursor:pointer;accent-color:var(--primary-color)}.checkbox-group{padding:5px 0}.io-section{margin-top:30px;padding:20px;border:1px solid var(--medium-gray);border-radius:var(--border-radius);background-color:#fdfdfd}.io-section h2{border-bottom:none;margin-bottom:15px}#importJsonArea{margin-top:10px}#importFile{display:none}.file-upload-label{cursor:pointer;padding:12px 20px}@media (max-width:600px){.container{padding:20px}button,.button-like{width:100%;margin-right:0}.checkbox-label-inline{width:45%}}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.container{animation:fadeIn .5s ease-out}#notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);background-color:var(--success-color);color:#fff;padding:12px 25px;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:1000;display:none;opacity:0;transition:opacity .5s ease,transform .5s ease;font-weight:500}#notification.show{display:block;opacity:1;transform:translate(-50%,0)}#notification.error{background-color:var(--danger-color)}#notification:not(.show){transform:translate(-50%,-50px)}
    </style>
</head>
<body>

<div id="notification"></div>

<div class="container">
    <h1>高级网盘与工具配置生成器</h1>
    <!-- Import/Export Section -->
    <div class="io-section">
        <h2>导入/导出</h2>
        <div>
            <label for="importFile" class="button-like secondary file-upload-label">从文件导入配置 (.json)</label>
            <input type="file" id="importFile" accept=".json,application/json" onchange="importFromFile(event)">
        </div>
        <div style="margin-top: 15px;">
            <label for="importJsonArea">或者粘贴 JSON 配置到下方并导入:</label>
            <textarea id="importJsonArea" rows="5" placeholder="在此处粘贴 JSON 配置 (支持 // 注释和常见粘贴错误修复)..."></textarea>
            <button type="button" class="secondary" onclick="importFromJsonText()">从文本导入</button>
        </div>
    </div>
    <p class="description">请填写配置。**网盘**可拖拽排序并勾选启用。**画质**只需勾选启用即可。导入时会自动尝试移除 JSON 中的 `//` 行注释和修复常见粘贴错误。</p>

    <form id="configForm">
        <!-- Pan Order Section -->
        <div class="field-group">
            <h3>网盘启用与排序 (拖拽排序)</h3>
            <p class="description">勾选需要使用的网盘，拖动项目调整它们的优先级顺序。</p>
            <ul id="panOrderList" class="sortable-list"></ul>
            <input type="hidden" id="panDefaultOrder" value="uc|p123|quark|ali|yd|ty|115">
        </div>

        <!-- Quality Selection Section -->
        <div class="field-group">
            <h3>画质选择</h3>
            <p class="description">勾选您需要启用的画质。顺序将按默认设置 (`原畫|普畫`)。</p>
            <div id="qualityCheckboxes" class="checkbox-group"></div>
            <input type="hidden" id="qualityDefaultOrder" value="原畫|普畫">
        </div>

        <!-- Other Config Fields -->
        <div class="field-group"><h3>阿里云盘 (Ali)</h3><label for="aliToken">Ali Token:</label><input type="text" id="aliToken" name="aliToken" placeholder="粘贴阿里云盘的 Token"></div>
        <div class="field-group"><h3>夸克网盘 (Quark)</h3><label for="quarkCookie">Quark Cookie:</label><textarea id="quarkCookie" name="quarkCookie" placeholder="粘贴夸克网盘的 Cookie (通常很长)"></textarea></div>
        <div class="field-group"><h3>UC网盘 (UC)</h3><label for="ucCookie">UC Cookie:</label><textarea id="ucCookie" name="ucCookie" placeholder="粘贴UC网盘的 Cookie (通常很长)"></textarea><label for="ucToken">UC Token (可选):</label><input type="text" id="ucToken" name="ucToken" placeholder="如果需要，粘贴UC网盘的 Token"><label for="ucUt">UC Ut (可选):</label><input type="text" id="ucUt" name="ucUt" placeholder="如果需要，粘贴UC网盘的 Ut 值"></div>
        <div class="field-group"><h3>115网盘 (115)</h3><label for="115Cookie">115 Cookie:</label><textarea id="115Cookie" name="115Cookie" placeholder="粘贴115网盘的 Cookie (通常很长)"></textarea><label for="pwdRb115">115 密码/Rb (可选):</label><input type="text" id="pwdRb115" name="pwdRb115" placeholder="如果需要，输入115相关密码或值"></div>
        <div class="field-group"><h3>123云盘 (p123)</h3><label for="p123Auth">p123 账号密码:</label><input type="text" id="p123Auth" name="p123Auth" placeholder="格式：账号|密码"></div>
        <div class="field-group"><h3>移动云盘 (yd)</h3><label for="ydAuth">移动云盘 Auth:</label><input type="text" id="ydAuth" name="ydAuth" placeholder="粘贴移动云盘的认证信息"></div>
        <div class="field-group"><h3>天翼云盘 (ty)</h3><label for="tyAuth">天翼云盘 账号密码:</label><input type="text" id="tyAuth" name="tyAuth" placeholder="格式：账号|密码"></div>
<!--        <div class="field-group"><h3>百度网盘 (Baidu)</h3><label for="baiduCookie">Baidu Cookie:</label><textarea id="baiduCookie" name="baiduCookie" placeholder="粘贴百度网盘的 Cookie (如果需要使用)"></textarea></div>-->
        <div class="field-group"><h3>其他设置</h3><label for="tgPic">启用TG预览图:</label><select id="tgPic" name="tgPic"><option value="true" selected>是 (true)</option><option value="false">否 (false)</option></select><label for="goServerUrl">后端服务地址:</label><input type="text" id="goServerUrl" name="goServerUrl" value="http://127.0.0.1:9966" placeholder="例如：http://127.0.0.1:9966"><label for="proxy">代理服务器 (可选):</label><input type="text" id="proxy" name="proxy" placeholder="例如：http://127.0.0.1:1080 或 socks5://127.0.0.1:1081"><label for="exeAddr">执行文件地址 (可选):</label><input type="text" id="exeAddr" name="exeAddr" placeholder="如果需要，填写执行文件路径"></div>

        <!-- Action Buttons -->
        <div style="margin-top: 30px; text-align: center;">
            <button type="button" onclick="previewJson()">预览配置</button>
            <button type="button" class="secondary" onclick="downloadJson()">下载配置</button>
            <button type="button" class="danger" onclick="resetForm()">重置表单</button>
        </div>

        <!-- Preview Area -->
        <div id="previewArea" style="margin-top: 20px;">
            <h2>预览生成的 JSON 配置:</h2>
            <textarea id="outputJson" rows="20" readonly placeholder="点击“预览配置”后，结果将显示在此处"></textarea>
        </div>
    </form>
</div>

<script>
    // --- Global References ---
    const panListEl = document.getElementById('panOrderList');
    const qualityCheckboxesEl = document.getElementById('qualityCheckboxes');
    const defaultPans = document.getElementById('panDefaultOrder').value.split('|');
    const defaultQualities = document.getElementById('qualityDefaultOrder').value.split('|');
    const notificationEl = document.getElementById('notification');
    let notificationTimeout;

    // --- Notification Function ---
    function showNotification(message, type = 'success', duration = 3500) {
        notificationEl.textContent = message;
        notificationEl.className = 'notification'; // Base class
        notificationEl.classList.add(type);
        notificationEl.classList.add('show');
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
            notificationEl.classList.remove('show');
        }, duration);
    }

    // --- Create Draggable Item (For Pans) ---
    function createDraggableItem(id, name, isChecked = true) {
        const li = document.createElement('li');
        li.className = 'draggable-item';
        li.dataset.id = id;
        li.innerHTML = `
            <span class="handle">☰</span>
            <span class="item-name">${name}</span>
            <label class="checkbox-label">
                <input type="checkbox" ${isChecked ? 'checked' : ''}> 启用
            </label>
        `;
        return li;
    }

    // --- Populate Draggable List (For Pans) ---
    function populateSortableList(element, items, defaultOrder) {
        const existingCheckStatus = {};
        element.querySelectorAll('.draggable-item').forEach(li => {
            const checkbox = li.querySelector('input[type="checkbox"]');
            if (checkbox) { existingCheckStatus[li.dataset.id] = checkbox.checked; }
        });
        element.innerHTML = '';
        const presentItems = new Set(items);
        items.forEach(item => {
            const isChecked = existingCheckStatus.hasOwnProperty(item) ? existingCheckStatus[item] : true;
            element.appendChild(createDraggableItem(item, item, isChecked));
        });
        defaultOrder.forEach(item => {
            if (!presentItems.has(item)) {
                const isChecked = existingCheckStatus.hasOwnProperty(item) ? existingCheckStatus[item] : false;
                element.appendChild(createDraggableItem(item, item, isChecked));
            }
        });
    }

    // --- Populate Simple Checkboxes (For Qualities) ---
    function populateCheckboxes(container, items, defaultCheckedItems = []) {
        container.innerHTML = '';
        const checkedSet = new Set(defaultCheckedItems);
        items.forEach(item => {
            const checkboxId = `qualityCheckboxes-${item}`;
            const label = document.createElement('label');
            label.className = 'checkbox-label-inline';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.id = checkboxId; checkbox.value = item;
            checkbox.checked = checkedSet.has(item);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${item}`));
            container.appendChild(label);
        });
    }

    // --- Initialize SortableJS (Pans Only) ---
    function initializeSortable(element) {
        return new Sortable(element, {
            animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag', forceFallback: true,
        });
    }

    // --- Get Ordered & Enabled Items from Sortable List (Pans) ---
    function getOrderedPanItems(element) {
        const items = [];
        element.querySelectorAll('.draggable-item').forEach(li => {
            const checkbox = li.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) { items.push(li.dataset.id); }
        });
        return items;
    }

    // --- Generate JSON Data (Core Logic) ---
    function generateJsonData() {
        const config = {};
        const selectedPans = getOrderedPanItems(panListEl);
        const selectedQualities = [];
        defaultQualities.forEach(quality => {
            const checkbox = qualityCheckboxesEl.querySelector(`#qualityCheckboxes-${quality}`);
            if (checkbox && checkbox.checked) { selectedQualities.push(quality); }
        });
        config.panOrder = `${selectedPans.join('|')}##${selectedQualities.join('|')}`;
        const formElements = document.getElementById('configForm').elements;
        const skipIds = new Set(['panOrderList', 'qualityCheckboxes', 'importFile', 'importJsonArea']);
        for (let i = 0; i < formElements.length; i++) {
            const element = formElements[i];
            const id = element.id;
            const name = element.name;
            if ((id || name) && !element.closest('.sortable-list') && !element.closest('.checkbox-group')) {
                const configKey = name || id;
                if (!skipIds.has(id) && !id.startsWith('panDefaultOrder') && !id.startsWith('qualityDefaultOrder')) {
                    const key = (id === '115Cookie' || id === 'pwdRb115') ? id : configKey;
                    if (key) { config[key] = element.value.trim(); }
                }
            }
        }

        config.tgPic = document.getElementById('tgPic').value;
        return config;
    }

    // --- Display JSON Preview ---
    function previewJson() {
        try {
            const config = generateJsonData();
            // **Exclude 'outputJson' field specifically before stringifying for preview**
            if ('outputJson' in config) {
                delete config.outputJson;
            }
            const outputJsonString = JSON.stringify(config, null, 2);
            document.getElementById('outputJson').value = outputJsonString;
            showNotification('配置已生成并预览！');
        } catch (error) {
            console.error("Error generating JSON:", error);
            showNotification('生成配置时出错: ' + error.message, 'error');
            document.getElementById('outputJson').value = "生成错误: " + error.message;
        }
    }

    // --- Download JSON File ---
    function downloadJson() {
        try {
            const config = generateJsonData();
            // **Exclude 'outputJson' field specifically before stringifying for download**
            if ('outputJson' in config) {
                delete config.outputJson;
            }
            const jsonString = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'config.json';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('配置文件已开始下载！');
        } catch (error) {
            console.error("Error downloading JSON:", error);
            showNotification('下载配置时出错: ' + error.message, 'error');
        }
    }

    // --- **REFINED** Helper to sanitize JSON input ---
    function sanitizeJsonInput(jsonString) {
        return jsonString.replace(/("(?:[^"\\]|\\.)*")|(\/\/.*)/g, (match, strPart, comment) => {
            return comment ? '' : strPart; // 保留字符串，删除注释
        });
    }


    // --- Populate Form from Imported Data ---
    function populateForm(config) {
        if (!config || typeof config !== 'object') {
            showNotification('无效的配置数据。', 'error');
            return false;
        }

        // **Ignore the 'outputJson' field if it exists in the imported data**
        if ('outputJson' in config) {
            console.log("Ignoring 'outputJson' field found in imported data.");
            delete config.outputJson;
        }

        let pans = defaultPans;
        let enabledQualitiesSet = new Set(defaultQualities);

        if (config.panOrder && typeof config.panOrder === 'string') {
            const parts = config.panOrder.split('##');
            if (parts[0]) { pans = parts[0].split('|'); }
            const qualitiesFromConfig = (parts[1] && parts[1] !== '') ? parts[1].split('|') : [];
            enabledQualitiesSet = new Set(qualitiesFromConfig);
        } else { console.warn("Imported JSON missing or invalid 'panOrder'. Using defaults."); }

        populateSortableList(panListEl, pans, defaultPans);
        populateCheckboxes(qualityCheckboxesEl, defaultQualities, Array.from(enabledQualitiesSet));

        for (const key in config) {
            // The check `config.hasOwnProperty(key)` is implicitly handled by `for...in` on plain objects
            // We already deleted outputJson, so no need to check here again
            if (key !== 'panOrder') {
                const element = document.getElementById(key) || document.getElementsByName(key)[0];
                if (element && !element.closest('.sortable-list') && !element.closest('.checkbox-group')) {
                    if (element.tagName === 'SELECT') {
                        const valueToSet = String(config[key]).toLowerCase();
                        let valueExists = false;
                        for (let i = 0; i < element.options.length; i++) { if (element.options[i].value === valueToSet) { valueExists = true; break; } }
                        element.value = valueExists ? valueToSet : element.options[0].value; // Use first option value as fallback
                    } else {
                        element.value = config[key] != null ? config[key] : ''; // Handle null/undefined
                    }
                } else if (key !== 'panOrder') { console.warn(`Config key "${key}" has no matching form element.`); }
            }
        }
        return true;
    }


    // --- Import from JSON Text Area ---
    function importFromJsonText() {
        const jsonText = document.getElementById('importJsonArea').value;
        if (!jsonText) { showNotification('请粘贴 JSON 内容到文本框中。', 'error'); return; }
        try {
            console.log("--- Import From Text Start ---");
            debugger
            const sanitizedJsonText = sanitizeJsonInput(jsonText);
            const finalJsonToParse = sanitizedJsonText; // Already trimmed in sanitize function
            console.log("Attempting to parse:", finalJsonToParse);
            if (!finalJsonToParse) {
                showNotification('清理后内容为空。', 'error'); return;
            }
            const parsedConfig = JSON.parse(finalJsonToParse);
            if (populateForm(parsedConfig)) {
                showNotification('配置已成功从文本导入！');
                previewJson(); // Update preview after import
                document.getElementById('importJsonArea').value = '';
            }
            console.log("--- Import From Text End ---");
        } catch (error) {
            console.error("Error parsing JSON from text:", error);
            showNotification(`导入失败：JSON 格式无效或无法解析。\n错误: ${error.message}`, 'error', 6000);
            console.log("--- Import From Text Failed ---");
        }
    }

    // --- Import from File ---
    function importFromFile(event) {
        const file = event.target.files[0];
        const fileInput = event.target;
        if (!file) { return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                console.log(`--- Import From File Start (${file.name}) ---`);
                const fileContent = e.target.result;
                const sanitizedJsonText = sanitizeJsonInput(fileContent);
                const finalJsonToParse = sanitizedJsonText; // Already trimmed
                console.log("Attempting to parse:", finalJsonToParse);
                if (!finalJsonToParse) {
                    showNotification('文件清理后内容为空。', 'error');
                    fileInput.value = ''; return;
                }
                const parsedConfig = JSON.parse(finalJsonToParse);
                if (populateForm(parsedConfig)) {
                    showNotification(`文件 '${file.name}' 配置已成功导入！`);
                    previewJson(); // Update preview after import
                }
                console.log("--- Import From File End ---");
            } catch (error) {
                console.error(`Error parsing JSON from file '${file.name}':`, error);
                showNotification(`导入失败：文件 '${file.name}' 内容 JSON 格式无效。\n错误: ${error.message}`, 'error', 6000);
                console.log("--- Import From File Failed ---");
            } finally {
                if(fileInput) fileInput.value = '';
            }
        };
        reader.onerror = function() {
            showNotification(`读取文件 '${file.name}' 时出错。`, 'error');
            if(fileInput) fileInput.value = '';
            console.log("--- Import From File Read Error ---");
        };
        reader.readAsText(file);
    }

    // --- Reset Form ---
    function resetForm() {
        if (confirm('确定要重置所有表单字段为默认值吗？')) {
            document.getElementById('configForm').reset();
            populateSortableList(panListEl, defaultPans, defaultPans);
            populateCheckboxes(qualityCheckboxesEl, defaultQualities, defaultQualities);
            document.getElementById('outputJson').value = '';
            document.getElementById('goServerUrl').value = 'http://127.0.0.1:9966';

            document.getElementById('tgPic').value = 'true';
            showNotification('表单已重置为默认值。');
        }
    }


    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        populateSortableList(panListEl, defaultPans, defaultPans);
        initializeSortable(panListEl);
        populateCheckboxes(qualityCheckboxesEl, defaultQualities, defaultQualities);
        document.getElementById('goServerUrl').value = 'http://127.0.0.1:9966';

        document.getElementById('tgPic').value = 'true';
    });
</script>

</body>
</html>