name: Deploy VitePress to GitHub Pages

on:
  push:
    paths:
      - 'docs/docs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: System Hardening
        run: |
          # 修复可能的权限问题
          sudo chown -R $(whoami):$(whoami) .
          sudo chmod -R 755 docs
          
          # 系统资源检查
          echo "=== 系统资源 ==="
          ulimit -a
          df -ih
          free -h

      - name: Build with Atomic Checks
        working-directory: docs/docs
        run: |
          # 强制清理环境
          rm -rf .vitepress/dist node_modules/.vite .vitepress/cache
          
          # 创建验证锁文件
          echo "Build started at $(date)" > build.lock
          
          # 带资源限制的构建
          NODE_OPTIONS="--max-old-space-size=4096" pnpm run build 2>&1 | tee build.log
          
          # 原子验证
          if [ ! -f ".vitepress/dist/index.html" ]; then
            echo "=== 构建失败诊断 ==="
            echo "最后10行日志:"
            tail -n 10 build.log
            echo "VitePress版本:"
            pnpm list vitepress
            echo "目录结构:"
            tree -a -L 3
            exit 1
          fi
          
          # 验证文件完整性
          find .vitepress/dist -type f -exec file {} \; | grep -v "ASCII text" && \
            echo "发现非文本文件" || echo "全部为文本文件可能有问题"

      - name: Prepare Deployment
        run: |
          # 双重验证
          [ -f "docs/docs/.vitepress/dist/index.html" ] || exit 1
          
          mkdir -p docs/bk
          rsync -av --delete docs/docs/.vitepress/dist/ docs/bk/
          
          # 最终验证
          [ $(wc -c < docs/bk/index.html) -gt 1000 ] || {
            echo "生成文件过小，内容可能不完整"
            exit 1
          }

      - uses: actions/upload-pages-artifact@v3
        with:
          path: docs/bk

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/deploy-pages@v4