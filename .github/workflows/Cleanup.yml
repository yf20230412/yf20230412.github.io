# é«˜æ•ˆæ¸…ç†æ—§å·¥ä½œæµè®°å½•ï¼Œå…¬å¼€ä»“åº“ä½¿ç”¨
# æ— éœ€é…ç½®Token
name: Cleanup Old Workflows (Public Repo Optimized)
on:
  schedule:
    - cron: '0 1 */3 * *'  # æ¯3å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ
  workflow_dispatch:

permissions:
  actions: write  # ä»…éœ€åˆ é™¤å·¥ä½œæµçš„æƒé™
  contents: read  # é»˜è®¤å·²å…·å¤‡ï¼ˆå…¬å¼€ä»“åº“ï¼‰

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä¸éœ€è¦tokenå‚æ•°

      - name: Cleanup in Batches
        uses: actions/github-script@v6
        env:
          RETENTION_DAYS: 1  # ä¿ç•™æœ€è¿‘1å¤©çš„è®°å½•
          BATCH_SIZE: 30     # æ¯æ‰¹æ¬¡å¤„ç†30æ¡
          MAX_PAGES: 5       # æœ€å¤šæ£€æŸ¥5é¡µ
        with:
          script: |
            const { RETENTION_DAYS, BATCH_SIZE, MAX_PAGES } = process.env;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(RETENTION_DAYS));

            let deletedCount = 0;
            let skippedCount = 0;
            let protectedCount = 0;
            let errorCount = 0;
            let page = 1;
            
            console.log('ğŸ› ï¸ å¼€å§‹æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•...');
            console.log(`â³ é…ç½®å‚æ•°: ä¿ç•™å¤©æ•°=${RETENTION_DAYS}, æ¯æ‰¹=${BATCH_SIZE}æ¡, æœ€å¤§é¡µæ•°=${MAX_PAGES}`);

            // åˆ†æ‰¹æ¸…ç†
            while (page <= parseInt(MAX_PAGES)) {
              console.log(`ğŸ“– æ­£åœ¨å¤„ç†ç¬¬ ${page} é¡µ...`);
              
              try {
                const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: parseInt(BATCH_SIZE),
                  page: page,
                  status: 'completed',
                });

                if (runs.workflow_runs.length === 0) {
                  console.log('â¹ï¸ æ²¡æœ‰æ›´å¤šå·¥ä½œæµè¿è¡Œè®°å½•');
                  break;
                }

                for (const run of runs.workflow_runs) {
                  if (new Date(run.created_at) < cutoffDate) {
                    try {
                      await github.rest.actions.deleteWorkflowRun({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: run.id,
                      });
                      deletedCount++;
                      console.log(`â™»ï¸ å·²åˆ é™¤ #${run.id} (${run.created_at})`);

                      // æ¯10æ¡æš‚åœ10ç§’é¿å…é™é€Ÿ
                      if (deletedCount % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10000));
                      }
                    } catch (error) {
                      errorCount++;
                      console.error(`âŒ åˆ é™¤ #${run.id} å¤±è´¥: ${error.message}`);
                    }
                  } else {
                    skippedCount++;
                    console.log(`â­ï¸ è·³è¿‡ #${run.id} (åˆ›å»ºäº ${run.created_at})`);
                  }
                }
              } catch (error) {
                console.error(`âš ï¸ è·å–ç¬¬ ${page} é¡µå¤±è´¥: ${error.message}`);
                break;
              }

              page++;
              // é¡µé—´æš‚åœ10ç§’
              await new Promise(resolve => setTimeout(resolve, 10000));
            }

            // ç»“æœæŠ¥å‘Š
            console.log('\nğŸ“Š æ¸…ç†ç»“æœç»Ÿè®¡:');
            console.log(`âœ… æˆåŠŸåˆ é™¤: ${deletedCount}`);
            console.log(`â­ï¸ è·³è¿‡è®°å½•: ${skippedCount}`);
            console.log(`âŒ å¤±è´¥æ¬¡æ•°: ${errorCount}`);

            // ç”Ÿæˆå¯è§†åŒ–æ‘˜è¦
            try {
              await core.summary
                .addHeading('ğŸ§¹ å·¥ä½œæµæ¸…ç†æŠ¥å‘Š')
                .addTable([
                  ['æ“ä½œç±»å‹', 'æ•°é‡'],
                  ['âœ… æˆåŠŸåˆ é™¤', deletedCount.toString()],
                  ['â­ï¸ è·³è¿‡è®°å½•', skippedCount.toString()],
                  ['âŒ å¤±è´¥æ¬¡æ•°', errorCount.toString()]
                ])
                .addBreak()
                .addRaw(`â±ï¸ ä¿ç•™å¤©æ•°: ${RETENTION_DAYS}å¤© | æ‰§è¡Œæ—¶é—´: ${new Date().toLocaleString()}`)
                .write();
              
              console.log('ğŸ“Œ æ‘˜è¦å·²ç”Ÿæˆåˆ°å·¥ä½œæµ Summary é€‰é¡¹å¡');
            } catch (summaryError) {
              console.error('âš ï¸ ç”Ÿæˆæ‘˜è¦å¤±è´¥:', summaryError.message);
            }

            // å¦‚æœ‰é”™è¯¯åˆ™æ ‡è®°å¤±è´¥
            if (errorCount > 0) {
              core.setFailed(`æ¸…ç†å®Œæˆï¼Œä½†æœ‰ ${errorCount} ä¸ªé”™è¯¯`);
            } else {
              console.log('ğŸ‰ æ¸…ç†ä»»åŠ¡å®Œæˆ');
            }